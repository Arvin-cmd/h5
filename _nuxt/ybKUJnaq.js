import{aD as l,aj as V,ak as H,V as A,aE as g,aF as B,aG as S,aH as x,aI as M,aJ as F,aK as I,aL as y,aM as L,aN as C,aO as $,aP as Q,aQ as j,aR as G,aS as q,aT as K,al as Y,am as J,Q as X,T as Z,U as ee,R as oe,S as W}from"./DHezVORj.js";import{n as z,c as ne}from"./BKvf9UeB.js";import"./D3K2RGSn.js";import"./B23v9XD5.js";const P={getGasPriceInEther(o,t){const n=t*o;return Number(n)/1e18},getGasPriceInUSD(o,t,n){const s=P.getGasPriceInEther(t,n);return l.bigNumber(o).times(s).toNumber()},getPriceImpact({sourceTokenAmount:o,sourceTokenPriceInUSD:t,toTokenPriceInUSD:n,toTokenAmount:s}){const i=l.bigNumber(o).times(t),a=l.bigNumber(s).times(n);return i.minus(a).div(i).times(100).toNumber()},getMaxSlippage(o,t){const n=l.bigNumber(o).div(100);return l.multiply(t,n).toNumber()},getProviderFee(o,t=.0085){return l.bigNumber(o).times(t).toString()},isInsufficientNetworkTokenForGas(o,t){const n=t||"0";return l.bigNumber(o).eq(0)?!0:l.bigNumber(l.bigNumber(n)).gt(o)},isInsufficientSourceTokenForSwap(o,t,n){var a,u;const s=(u=(a=n==null?void 0:n.find(c=>c.address===t))==null?void 0:a.quantity)==null?void 0:u.numeric;return l.bigNumber(s||"0").lt(o)},getToTokenAmount({sourceToken:o,toToken:t,sourceTokenPrice:n,toTokenPrice:s,sourceTokenAmount:i}){if(i==="0"||!o||!t)return"0";const a=o.decimals,u=n,c=t.decimals,d=s;if(d<=0)return"0";const T=l.bigNumber(i).times(.0085),f=l.bigNumber(i).minus(T).times(l.bigNumber(10).pow(a)),w=l.bigNumber(u).div(d),b=a-c;return f.times(w).div(l.bigNumber(10).pow(b)).div(l.bigNumber(10).pow(c)).toFixed(c).toString()}},R=15e4,te=6,k={initializing:!1,initialized:!1,loadingPrices:!1,loadingQuote:!1,loadingApprovalTransaction:!1,loadingBuildTransaction:!1,loadingTransaction:!1,fetchError:!1,approvalTransaction:void 0,swapTransaction:void 0,transactionError:void 0,sourceToken:void 0,sourceTokenAmount:"",sourceTokenPriceInUSD:0,toToken:void 0,toTokenAmount:"",toTokenPriceInUSD:0,networkPrice:"0",networkBalanceInUSD:"0",networkTokenSymbol:"",inputError:void 0,slippage:G.CONVERT_SLIPPAGE_TOLERANCE,tokens:void 0,popularTokens:void 0,suggestedTokens:void 0,foundTokens:void 0,myTokensWithBalance:void 0,tokensPriceMap:{},gasFee:"0",gasPriceInUSD:0,priceImpact:void 0,maxSlippage:void 0,providerFee:void 0},e=H(k),N={state:e,subscribe(o){return J(e,()=>o(e))},subscribeKey(o,t){return Y(e,o,t)},getParams(){var c,d,T,m,f,w,b,h;const o=I.state.activeCaipAddress,t=L.getPlainAddress(o),n=q(),s=K.getConnectorId(I.state.activeChain);if(!t)throw new Error("No address found to swap the tokens from.");const i=!((c=e.toToken)!=null&&c.address)||!((d=e.toToken)!=null&&d.decimals),a=!((T=e.sourceToken)!=null&&T.address)||!((m=e.sourceToken)!=null&&m.decimals)||!l.bigNumber(e.sourceTokenAmount).gt(0),u=!e.sourceTokenAmount;return{networkAddress:n,fromAddress:t,fromCaipAddress:o,sourceTokenAddress:(f=e.sourceToken)==null?void 0:f.address,toTokenAddress:(w=e.toToken)==null?void 0:w.address,toTokenAmount:e.toTokenAmount,toTokenDecimals:(b=e.toToken)==null?void 0:b.decimals,sourceTokenAmount:e.sourceTokenAmount,sourceTokenDecimals:(h=e.sourceToken)==null?void 0:h.decimals,invalidToToken:i,invalidSourceToken:a,invalidSourceTokenAmount:u,availableToSwap:o&&!i&&!a&&!u,isAuthConnector:s===S.CONNECTOR_ID.AUTH}},setSourceToken(o){if(!o){e.sourceToken=o,e.sourceTokenAmount="",e.sourceTokenPriceInUSD=0;return}e.sourceToken=o,r.setTokenPrice(o.address,"sourceToken")},setSourceTokenAmount(o){e.sourceTokenAmount=o},setToToken(o){if(!o){e.toToken=o,e.toTokenAmount="",e.toTokenPriceInUSD=0;return}e.toToken=o,r.setTokenPrice(o.address,"toToken")},setToTokenAmount(o){e.toTokenAmount=o?l.formatNumberToLocalString(o,te):""},async setTokenPrice(o,t){let n=e.tokensPriceMap[o]||0;n||(e.loadingPrices=!0,n=await r.getAddressPrice(o)),t==="sourceToken"?e.sourceTokenPriceInUSD=n:t==="toToken"&&(e.toTokenPriceInUSD=n),e.loadingPrices&&(e.loadingPrices=!1),r.getParams().availableToSwap&&r.swapTokens()},switchTokens(){if(e.initializing||!e.initialized)return;const o=e.toToken?{...e.toToken}:void 0,t=e.sourceToken?{...e.sourceToken}:void 0,n=o&&e.toTokenAmount===""?"1":e.toTokenAmount;r.setSourceToken(o),r.setToToken(t),r.setSourceTokenAmount(n),r.setToTokenAmount(""),r.swapTokens()},resetState(){e.myTokensWithBalance=k.myTokensWithBalance,e.tokensPriceMap=k.tokensPriceMap,e.initialized=k.initialized,e.sourceToken=k.sourceToken,e.sourceTokenAmount=k.sourceTokenAmount,e.sourceTokenPriceInUSD=k.sourceTokenPriceInUSD,e.toToken=k.toToken,e.toTokenAmount=k.toTokenAmount,e.toTokenPriceInUSD=k.toTokenPriceInUSD,e.networkPrice=k.networkPrice,e.networkTokenSymbol=k.networkTokenSymbol,e.networkBalanceInUSD=k.networkBalanceInUSD,e.inputError=k.inputError,e.myTokensWithBalance=k.myTokensWithBalance},resetValues(){var n;const{networkAddress:o}=r.getParams(),t=(n=e.tokens)==null?void 0:n.find(s=>s.address===o);r.setSourceToken(t),r.setToToken(void 0)},getApprovalLoadingState(){return e.loadingApprovalTransaction},clearError(){e.transactionError=void 0},async initializeState(){if(!e.initializing){if(e.initializing=!0,!e.initialized)try{await r.fetchTokens(),e.initialized=!0}catch{e.initialized=!1,g.showError("Failed to initialize swap"),A.goBack()}e.initializing=!1}},async fetchTokens(){var n;const{networkAddress:o}=r.getParams();await r.getTokenList(),await r.getNetworkTokenPrice(),await r.getMyTokensWithBalance();const t=(n=e.tokens)==null?void 0:n.find(s=>s.address===o);t&&(e.networkTokenSymbol=t.symbol,r.setSourceToken(t),r.setSourceTokenAmount("0"))},async getTokenList(){const o=await C.getTokenList();e.tokens=o,e.popularTokens=o.sort((t,n)=>t.symbol<n.symbol?-1:t.symbol>n.symbol?1:0),e.suggestedTokens=o.filter(t=>!!G.SWAP_SUGGESTED_TOKENS.includes(t.symbol),{})},async getAddressPrice(o){var d,T;const t=e.tokensPriceMap[o];if(t)return t;const n=await y.fetchTokenPrice({addresses:[o]}),s=(n==null?void 0:n.fungibles)||[],i=[...e.tokens||[],...e.myTokensWithBalance||[]],a=(d=i==null?void 0:i.find(m=>m.address===o))==null?void 0:d.symbol,u=((T=s.find(m=>m.symbol.toLowerCase()===(a==null?void 0:a.toLowerCase())))==null?void 0:T.price)||0,c=parseFloat(u.toString());return e.tokensPriceMap[o]=c,c},async getNetworkTokenPrice(){var i;const{networkAddress:o}=r.getParams(),n=(i=(await y.fetchTokenPrice({addresses:[o]}).catch(()=>(g.showError("Failed to fetch network token price"),{fungibles:[]}))).fungibles)==null?void 0:i[0],s=(n==null?void 0:n.price.toString())||"0";e.tokensPriceMap[o]=parseFloat(s),e.networkTokenSymbol=(n==null?void 0:n.symbol)||"",e.networkPrice=s},async getMyTokensWithBalance(o){const t=await j.getMyTokensWithBalance(o),n=C.mapBalancesToSwapTokens(t);n&&(await r.getInitialGasPrice(),r.setBalances(n))},setBalances(o){const{networkAddress:t}=r.getParams(),n=I.state.activeCaipNetwork;if(!n)return;const s=o.find(i=>i.address===t);o.forEach(i=>{e.tokensPriceMap[i.address]=i.price||0}),e.myTokensWithBalance=o.filter(i=>i.address.startsWith(n.caipNetworkId)),e.networkBalanceInUSD=s?l.multiply(s.quantity.numeric,s.price).toString():"0"},async getInitialGasPrice(){var t,n;const o=await C.fetchGasPrice();if(!o)return{gasPrice:null,gasPriceInUSD:null};switch((n=(t=I.state)==null?void 0:t.activeCaipNetwork)==null?void 0:n.chainNamespace){case S.CHAIN.SOLANA:return e.gasFee=o.standard??"0",e.gasPriceInUSD=l.multiply(o.standard,e.networkPrice).div(1e9).toNumber(),{gasPrice:BigInt(e.gasFee),gasPriceInUSD:Number(e.gasPriceInUSD)};case S.CHAIN.EVM:default:const s=o.standard??"0",i=BigInt(s),a=BigInt(R),u=P.getGasPriceInUSD(e.networkPrice,a,i);return e.gasFee=s,e.gasPriceInUSD=u,{gasPrice:i,gasPriceInUSD:u}}},async swapTokens(){var a,u;const o=$.state.address,t=e.sourceToken,n=e.toToken,s=l.bigNumber(e.sourceTokenAmount).gt(0);if(s||r.setToTokenAmount(""),!n||!t||e.loadingPrices||!s)return;e.loadingQuote=!0;const i=l.bigNumber(e.sourceTokenAmount).times(10**t.decimals).round(0);try{const c=await y.fetchSwapQuote({userAddress:o,from:t.address,to:n.address,gasPrice:e.gasFee,amount:i.toString()});e.loadingQuote=!1;const d=(u=(a=c==null?void 0:c.quotes)==null?void 0:a[0])==null?void 0:u.toAmount;if(!d){Q.open({displayMessage:"Incorrect amount",debugMessage:"Please enter a valid amount"},"error");return}const T=l.bigNumber(d).div(10**n.decimals).toString();r.setToTokenAmount(T),r.hasInsufficientToken(e.sourceTokenAmount,t.address)?e.inputError="Insufficient balance":(e.inputError=void 0,r.setTransactionDetails())}catch{e.loadingQuote=!1,e.inputError="Insufficient balance"}},async getTransaction(){const{fromCaipAddress:o,availableToSwap:t}=r.getParams(),n=e.sourceToken,s=e.toToken;if(!(!o||!t||!n||!s||e.loadingQuote))try{e.loadingBuildTransaction=!0;const i=await C.fetchSwapAllowance({userAddress:o,tokenAddress:n.address,sourceTokenAmount:e.sourceTokenAmount,sourceTokenDecimals:n.decimals});let a;return i?a=await r.createSwapTransaction():a=await r.createAllowanceTransaction(),e.loadingBuildTransaction=!1,e.fetchError=!1,a}catch{A.goBack(),g.showError("Failed to check allowance"),e.loadingBuildTransaction=!1,e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}},async createAllowanceTransaction(){const{fromCaipAddress:o,sourceTokenAddress:t,toTokenAddress:n}=r.getParams();if(!(!o||!n)){if(!t)throw new Error("createAllowanceTransaction - No source token address found.");try{const s=await y.generateApproveCalldata({from:t,to:n,userAddress:o}),i=L.getPlainAddress(s.tx.from);if(!i)throw new Error("SwapController:createAllowanceTransaction - address is required");const a={data:s.tx.data,to:i,gasPrice:BigInt(s.tx.eip155.gasPrice),value:BigInt(s.tx.value),toAmount:e.toTokenAmount};return e.swapTransaction=void 0,e.approvalTransaction={data:a.data,to:a.to,gasPrice:a.gasPrice,value:a.value,toAmount:a.toAmount},{data:a.data,to:a.to,gasPrice:a.gasPrice,value:a.value,toAmount:a.toAmount}}catch{A.goBack(),g.showError("Failed to create approval transaction"),e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}}},async createSwapTransaction(){var u;const{networkAddress:o,fromCaipAddress:t,sourceTokenAmount:n}=r.getParams(),s=e.sourceToken,i=e.toToken;if(!t||!n||!s||!i)return;const a=(u=B.parseUnits(n,s.decimals))==null?void 0:u.toString();try{const c=await y.generateSwapCalldata({userAddress:t,from:s.address,to:i.address,amount:a,disableEstimate:!0}),d=s.address===o,T=BigInt(c.tx.eip155.gas),m=BigInt(c.tx.eip155.gasPrice),f=L.getPlainAddress(c.tx.to);if(!f)throw new Error("SwapController:createSwapTransaction - address is required");const w={data:c.tx.data,to:f,gas:T,gasPrice:m,value:BigInt(d?a??"0":"0"),toAmount:e.toTokenAmount};return e.gasPriceInUSD=P.getGasPriceInUSD(e.networkPrice,T,m),e.approvalTransaction=void 0,e.swapTransaction=w,w}catch{A.goBack(),g.showError("Failed to create transaction"),e.approvalTransaction=void 0,e.swapTransaction=void 0,e.fetchError=!0;return}},onEmbeddedWalletApprovalSuccess(){g.showLoading("Approve limit increase in your wallet"),A.replace("SwapPreview")},async sendTransactionForApproval(o){var i,a,u;const{fromAddress:t,isAuthConnector:n}=r.getParams();e.loadingApprovalTransaction=!0,n?A.pushTransactionStack({onSuccess:r.onEmbeddedWalletApprovalSuccess}):g.showLoading("Approve limit increase in your wallet");try{await B.sendTransaction({address:t,to:o.to,data:o.data,value:o.value,chainNamespace:S.CHAIN.EVM}),await r.swapTokens(),await r.getTransaction(),e.approvalTransaction=void 0,e.loadingApprovalTransaction=!1}catch(c){const d=c;e.transactionError=d==null?void 0:d.displayMessage,e.loadingApprovalTransaction=!1,g.showError((d==null?void 0:d.displayMessage)||"Transaction error"),x.sendEvent({type:"track",event:"SWAP_APPROVAL_ERROR",properties:{message:(d==null?void 0:d.displayMessage)||(d==null?void 0:d.message)||"Unknown",network:((i=I.state.activeCaipNetwork)==null?void 0:i.caipNetworkId)||"",swapFromToken:((a=r.state.sourceToken)==null?void 0:a.symbol)||"",swapToToken:((u=r.state.toToken)==null?void 0:u.symbol)||"",swapFromAmount:r.state.sourceTokenAmount||"",swapToAmount:r.state.toTokenAmount||"",isSmartAccount:M(S.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}})}},async sendTransactionForSwap(o){var u,c,d,T,m,f,w,b,h,E,U,O;if(!o)return;const{fromAddress:t,toTokenAmount:n,isAuthConnector:s}=r.getParams();e.loadingTransaction=!0;const i=`Swapping ${(u=e.sourceToken)==null?void 0:u.symbol} to ${l.formatNumberToLocalString(n,3)} ${(c=e.toToken)==null?void 0:c.symbol}`,a=`Swapped ${(d=e.sourceToken)==null?void 0:d.symbol} to ${l.formatNumberToLocalString(n,3)} ${(T=e.toToken)==null?void 0:T.symbol}`;s?A.pushTransactionStack({onSuccess(){A.replace("Account"),g.showLoading(i),N.resetState()}}):g.showLoading("Confirm transaction in your wallet");try{const D=[(m=e.sourceToken)==null?void 0:m.address,(f=e.toToken)==null?void 0:f.address].join(","),p=await B.sendTransaction({address:t,to:o.to,data:o.data,value:o.value,chainNamespace:S.CHAIN.EVM});return e.loadingTransaction=!1,g.showSuccess(a),x.sendEvent({type:"track",event:"SWAP_SUCCESS",properties:{network:((w=I.state.activeCaipNetwork)==null?void 0:w.caipNetworkId)||"",swapFromToken:((b=r.state.sourceToken)==null?void 0:b.symbol)||"",swapToToken:((h=r.state.toToken)==null?void 0:h.symbol)||"",swapFromAmount:r.state.sourceTokenAmount||"",swapToAmount:r.state.toTokenAmount||"",isSmartAccount:M(S.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}}),N.resetState(),s||A.replace("Account"),N.getMyTokensWithBalance(D),p}catch(D){const p=D;e.transactionError=p==null?void 0:p.displayMessage,e.loadingTransaction=!1,g.showError((p==null?void 0:p.displayMessage)||"Transaction error"),x.sendEvent({type:"track",event:"SWAP_ERROR",properties:{message:(p==null?void 0:p.displayMessage)||(p==null?void 0:p.message)||"Unknown",network:((E=I.state.activeCaipNetwork)==null?void 0:E.caipNetworkId)||"",swapFromToken:((U=r.state.sourceToken)==null?void 0:U.symbol)||"",swapToToken:((O=r.state.toToken)==null?void 0:O.symbol)||"",swapFromAmount:r.state.sourceTokenAmount||"",swapToAmount:r.state.toTokenAmount||"",isSmartAccount:M(S.CHAIN.EVM)===F.ACCOUNT_TYPES.SMART_ACCOUNT}});return}},hasInsufficientToken(o,t){return P.isInsufficientSourceTokenForSwap(o,t,e.myTokensWithBalance)},setTransactionDetails(){const{toTokenAddress:o,toTokenDecimals:t}=r.getParams();!o||!t||(e.gasPriceInUSD=P.getGasPriceInUSD(e.networkPrice,BigInt(e.gasFee),BigInt(R)),e.priceImpact=P.getPriceImpact({sourceTokenAmount:e.sourceTokenAmount,sourceTokenPriceInUSD:e.sourceTokenPriceInUSD,toTokenPriceInUSD:e.toTokenPriceInUSD,toTokenAmount:e.toTokenAmount}),e.maxSlippage=P.getMaxSlippage(e.slippage,e.toTokenAmount),e.providerFee=P.getProviderFee(e.sourceTokenAmount))}},r=V(N),se=X`
  :host {
    display: block;
  }

  :host > button {
    gap: var(--wui-spacing-xxs);
    padding: var(--wui-spacing-xs);
    padding-right: var(--wui-spacing-1xs);
    height: 40px;
    border-radius: var(--wui-border-radius-l);
    background: var(--wui-color-gray-glass-002);
    border-width: 0px;
    box-shadow: inset 0 0 0 1px var(--wui-color-gray-glass-002);
  }

  :host > button wui-image {
    width: 24px;
    height: 24px;
    border-radius: var(--wui-border-radius-s);
    box-shadow: inset 0 0 0 1px var(--wui-color-gray-glass-010);
  }
`;var _=function(o,t,n,s){var i=arguments.length,a=i<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,n):s,u;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(o,t,n,s);else for(var c=o.length-1;c>=0;c--)(u=o[c])&&(a=(i<3?u(a):i>3?u(t,n,a):u(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a};let v=class extends oe{constructor(){super(...arguments),this.text=""}render(){return W`
      <button>
        ${this.tokenTemplate()}
        <wui-text variant="paragraph-600" color="fg-100">${this.text}</wui-text>
      </button>
    `}tokenTemplate(){return this.imageSrc?W`<wui-image src=${this.imageSrc}></wui-image>`:W`
      <wui-icon-box
        size="sm"
        iconColor="fg-200"
        backgroundColor="fg-300"
        icon="networkPlaceholder"
      ></wui-icon-box>
    `}};v.styles=[Z,ee,se];_([z()],v.prototype,"imageSrc",void 0);_([z()],v.prototype,"text",void 0);v=_([ne("wui-token-button")],v);export{r as S};
